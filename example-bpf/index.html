
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../img/bpd_icon.svg">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.6">
    
    
      
        <title>Example BPF Programs - bpfd</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4a0965b7.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#example-bpf-programs" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        <aside class="md-banner md-banner--warning">
          
        </aside>
      </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="bpfd" class="md-header__button md-logo" aria-label="bpfd" data-md-component="logo">
      
  <img src="../img/bpfd_icon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            bpfd
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Example BPF Programs
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/redhat-et/bpfd" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link md-tabs__link--active">
        Home
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="bpfd" class="md-nav__button md-logo" aria-label="bpfd" data-md-component="logo">
      
  <img src="../img/bpfd_icon.svg" alt="logo">

    </a>
    bpfd
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/redhat-et/bpfd" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="..">Home</a>
          
            <label for="__nav_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../building-bpfd/" class="md-nav__link">
        Setup and Building bpfd
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Example BPF Programs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Example BPF Programs
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deploying-locally" class="md-nav__link">
    Deploying Locally
  </a>
  
    <nav class="md-nav" aria-label="Deploying Locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building" class="md-nav__link">
    Building
  </a>
  
    <nav class="md-nav" aria-label="Building">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-locally" class="md-nav__link">
    Building Locally
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-on-host" class="md-nav__link">
    Running On Host
  </a>
  
    <nav class="md-nav" aria-label="Running On Host">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-privileged" class="md-nav__link">
    Running Privileged
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-unprivileged" class="md-nav__link">
    Running Unprivileged
  </a>
  
    <nav class="md-nav" aria-label="Running Unprivileged">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-bpfd-user-group" class="md-nav__link">
    Step 1: Create bpfd User Group
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-grant-cap_bpf-linux-capability" class="md-nav__link">
    Step 2: Grant CAP_BPF Linux Capability
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-start-go-xdp-counter-without-sudo" class="md-nav__link">
    Step 3: Start go-xdp-counter without sudo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-bpf-bytecode-in-a-container-image" class="md-nav__link">
    Passing BPF Bytecode In A Container Image
  </a>
  
    <nav class="md-nav" aria-label="Passing BPF Bytecode In A Container Image">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-bpf-bytecode-container-image" class="md-nav__link">
    Building BPF Bytecode Container Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preloading-bpf-bytecode" class="md-nav__link">
    Preloading BPF Bytecode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-on-kubernetes" class="md-nav__link">
    Deploying On Kubernetes
  </a>
  
    <nav class="md-nav" aria-label="Deploying On Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#loading-bpf-bytecode-on-kubernetes" class="md-nav__link">
    Loading BPF Bytecode On Kubernetes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-userspace-container-on-kubernetes" class="md-nav__link">
    Loading Userspace Container On Kubernetes
  </a>
  
    <nav class="md-nav" aria-label="Loading Userspace Container On Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-a-userspace-container-image" class="md-nav__link">
    Building A Userspace Container Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-a-userspace-container-image" class="md-nav__link">
    Loading A Userspace Container Image
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    Notes
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../k8s-deployment/" class="md-nav__link">
        How to Deploy bpfd on Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../image-build/" class="md-nav__link">
        BPFD Container Images
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linux-capabilities/" class="md-nav__link">
        Linux Capabilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../shipping-bytecode/" class="md-nav__link">
        EBPF Bytecode Image Specifications
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deploying-locally" class="md-nav__link">
    Deploying Locally
  </a>
  
    <nav class="md-nav" aria-label="Deploying Locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building" class="md-nav__link">
    Building
  </a>
  
    <nav class="md-nav" aria-label="Building">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-locally" class="md-nav__link">
    Building Locally
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-on-host" class="md-nav__link">
    Running On Host
  </a>
  
    <nav class="md-nav" aria-label="Running On Host">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-privileged" class="md-nav__link">
    Running Privileged
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-unprivileged" class="md-nav__link">
    Running Unprivileged
  </a>
  
    <nav class="md-nav" aria-label="Running Unprivileged">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-bpfd-user-group" class="md-nav__link">
    Step 1: Create bpfd User Group
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-grant-cap_bpf-linux-capability" class="md-nav__link">
    Step 2: Grant CAP_BPF Linux Capability
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-start-go-xdp-counter-without-sudo" class="md-nav__link">
    Step 3: Start go-xdp-counter without sudo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-bpf-bytecode-in-a-container-image" class="md-nav__link">
    Passing BPF Bytecode In A Container Image
  </a>
  
    <nav class="md-nav" aria-label="Passing BPF Bytecode In A Container Image">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-bpf-bytecode-container-image" class="md-nav__link">
    Building BPF Bytecode Container Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preloading-bpf-bytecode" class="md-nav__link">
    Preloading BPF Bytecode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-on-kubernetes" class="md-nav__link">
    Deploying On Kubernetes
  </a>
  
    <nav class="md-nav" aria-label="Deploying On Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#loading-bpf-bytecode-on-kubernetes" class="md-nav__link">
    Loading BPF Bytecode On Kubernetes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-userspace-container-on-kubernetes" class="md-nav__link">
    Loading Userspace Container On Kubernetes
  </a>
  
    <nav class="md-nav" aria-label="Loading Userspace Container On Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-a-userspace-container-image" class="md-nav__link">
    Building A Userspace Container Image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-a-userspace-container-image" class="md-nav__link">
    Loading A Userspace Container Image
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    Notes
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/redhat-et/bpfd/edit/main/docs/example-bpf.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="example-bpf-programs">Example BPF Programs</h1>
<p>Example applications that use the <code>bpfd-go</code> bindings can be found in
<a href="https://github.com/redhat-et/bpfd/tree/main/examples/go-xdp-counter">examples/go-xdp-counter/</a> and
<a href="https://github.com/redhat-et/bpfd/tree/main/examples/go-tc-counter">examples/go-tc-counter/</a>.
These examples and the associated documentation is intended to provide the basics on how to deploy
and manage a BPF program using bpfd.
There are two ways to deploy these example applications, simply run locally on one machine, or deploy
to multiple nodes in a Kubernetes cluster.</p>
<p>The <code>go-xdp-counter</code> and  <code>go-tc-counter</code> examples each contain a BPF Program written in C
(<a href="https://github.com/redhat-et/bpfd/tree/main/examples/go-xdp-counter/bpf/xdp_counter.c">xdp_counter.c</a> and
<a href="https://github.com/redhat-et/bpfd/tree/main/examples/go-tc-counter/bpf/tc_counter.c">tc_counter.c</a>)
that is compiled into BPF bytecode.
The BPF program counts packets that are received on an interface and stores the packet and byte
counts in a map that is accessible by the userspace portion.
The <code>go-xdp-counter</code> and  <code>go-tc-counter</code> examples each also have a userspace portion written in GO.
When run locally, the userspace program makes gRPC calls to <code>bpfd</code> requesting <code>bpfd</code> to load the BPF program
at the requested hook Point (XDP hook point or the TC hook point).
When run in a Kubernetes deployment, the <code>bpfd-agent</code> makes gRPC calls to <code>bpfd</code> requesting <code>bpfd</code> to load
the BPF program based on a <code>BpfProgramConfig</code> Custom Resource Definition (CRD), which is described in more
detail below.
Independent of the deployment, the userspace program then polls the BPF map every 3 seconds and logs the
current counts.
The userspace code is leveraging the <a href="https://github.com/cilium/ebpf">cilium/ebpf library</a>
to manage the maps shared with the BPF program.
The XDP and TC programs are very similar in functionality, and only vary where in the Linux networking stack
they are inserted.
Read more about XDP and TC programs <a href="https://docs.cilium.io/en/latest/bpf/progtypes/">here</a>.</p>
<h2 id="deploying-locally">Deploying Locally</h2>
<p>This section describes running bpfd and the example bpf programs on a local host.
When running bpfd, it can be run as a process or run as a systemd service.
Examples run the same, independent of how bpfd is deployed, other than requiring <code>sudo</code> or not.</p>
<h3 id="building">Building</h3>
<p>To build directly on a system, make sure all the prerequisites are met, then build.</p>
<h4 id="prerequisites">Prerequisites</h4>
<p><strong>Assuming bpfd is already installed and running on the system</strong></p>
<ol>
<li>All <a href="https://github.com/cilium/ebpf#requirements">requirements defined by the <code>cilium/ebpf</code> package</a></li>
<li>
<p>libbpf development package to get the required bpf c headers</p>
<p>Fedora:</p>
<p><code>sudo dnf install libbpf-devel</code></p>
<p>Ubuntu:</p>
<p><code>sudo apt-get install libbpf-dev</code></p>
</li>
<li>
<p>Cilium's <code>bpf2go</code> binary</p>
<p><code>go install github.com/cilium/ebpf/cmd/bpf2go@master</code></p>
</li>
</ol>
<h4 id="building-locally">Building Locally</h4>
<p>To build the C based BPF counter bytecode, run:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="go">    cd src/bpfd/examples/go-xdp-counter/</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="go">    go generate</span>
</code></pre></div>
<p>To build the Userspace GO Client run:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="go">    cd src/bpfd/examples/go-xdp-counter/</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="go">    go build</span>
</code></pre></div>
<p>Repeat for TC if desired:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="go">    cd src/bpfd/examples/go-tc-counter/</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="go">    go generate</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="go">    go build</span>
</code></pre></div>
<h3 id="running-on-host">Running On Host</h3>
<p>The most basic way to deploy this example is running directly on a host system.
First, start or ensure <code>bpfd</code> is up and running.
<a href="../tutorial/">Tutorial</a> will guide you through deploying <code>bpfd</code>.
In all the examples of running <code>go-xdp-counter</code> or <code>go-tc-counter</code> on a host system,
a bpfd-client certificate is used that is generated by <code>bpfd</code> to encrypt the application's
connection to <code>bpfd</code>.
The diagram below shows <code>go-xdp-counter</code> example, but the <code>go-tc-counter</code> example
operates exactly the same way.</p>
<p><img alt="go-xdp-counter On Host" src="../img/gocounter-on-host.png" /></p>
<p>Following the diagram (Purple numbers):</p>
<ol>
<li>When <code>go-xdp-counter</code> userspace is started, it will send a gRPC request
over mTLS to <code>bpfd</code> requesting <code>bpfd</code> to load the <code>go-xdp-counter</code> BPF bytecode located on disk
at <code>bpfd/examples/go-xdp-counter/bpf_bpfel.o</code> at a priority of 50 and on interface <code>ens3</code>.
These values are configurable as we will see later, but for now we will use the defaults
(except interface, which is required to be entered).</li>
<li><code>bpfd</code> will load it's <code>dispatcher</code> BPF program, which links to the <code>go-xdp-counter</code> BPF program
and return a UUID describing the running program.</li>
<li><code>bpfctl list</code> can be used to show that the BPF program was loaded.
<code>bpfctl</code> also sends gRPC requests over mTLS to perform actions and request data from <code>bpfd</code>.</li>
<li>Once the <code>go-xdp-counter</code> BPF bytecode is loaded, the BPF program will write packet counts
and byte counts to a shared map.</li>
<li><code>go-xdp-counter</code> userspace program periodically reads counters from the shared map and logs
the value.</li>
</ol>
<h4 id="running-privileged">Running Privileged</h4>
<p>The most basic example, just use <code>sudo</code> to start the <code>go-xdp-counter</code> program.
Determine the host interface to attach the BPF program to and then start the go program with:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="go">    cd src/bpfd/examples/go-xdp-counter/</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="go">    sudo ./go-xdp-counter -iface &lt;INTERNET INTERFACE NAME&gt;</span>
</code></pre></div>
<p>or (<strong>NOTE:</strong> TC programs also require a direction, ingress or egress)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="go">    cd src/bpfd/examples/go-tc-counter/</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="go">    sudo ./go-tc-counter -direction ingress -iface &lt;INTERNET INTERFACE NAME&gt;</span>
</code></pre></div>
<p>The output should show the count and total bytes of packets as they pass through the
interface as shown below:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="go">    sudo ./go-xdp-counter -iface ens3</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="go">    2022/12/02 15:59:34 Reading /etc/bpfd/gocounter.toml ...</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="go">    2022/12/02 15:59:34 Read /etc/bpfd/gocounter.toml failed: err open /etc/bpfd/gocounter.toml: no such file or directory</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="go">    2022/12/02 15:59:34 Using Input: Interface=ens3 Priority=50 Source=bpf_bpfel.o</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="go">    2022/12/02 15:59:35 Program registered with b6b2107c-f1a3-48ac-a145-1073c0979ba4 id</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="go">    2022/12/02 15:59:38 0 packets received</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="go">    2022/12/02 15:59:38 0 bytes received</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="go">    2022/12/02 15:59:41 4 packets received</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="go">    2022/12/02 15:59:41 580 bytes received</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="go">    :</span>
</code></pre></div>
<p>Use <code>bpfctl</code> to show the <code>go-xdp-counter</code> BPF bytecode was loaded.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="go">    bpfctl list</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="go">    UUID                                  Type  Name   Path                                                      Metadata</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="go">    b6b2107c-f1a3-48ac-a145-1073c0979ba4  xdp   stats  /home/$USER/src/bpfd/examples/go-xdp-counter/bpf_bpfel.o  { &quot;priority&quot;: 50, &quot;iface&quot;: &quot;ens3&quot;, &quot;position&quot;: 0, &quot;proceed_on&quot;: [&quot;pass&quot;, &quot;dispatcher_return&quot;] }</span>
</code></pre></div>
<p>Finally, press <code>&lt;CTRL&gt;+c</code> when finished with <code>go-xdp-counter</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="go">    :</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="go">    2022/12/02 16:00:56 64 packets received</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="go">    2022/12/02 16:00:56 9280 bytes received</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="go">    2022/12/02 16:00:59 64 packets received</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="go">    2022/12/02 16:00:59 9280 bytes received</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="go">    ^C2022/12/02 16:01:00 Exiting...</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="go">    2022/12/02 16:01:00 Unloading Program: b6b2107c-f1a3-48ac-a145-1073c0979ba4</span>
</code></pre></div>
<h4 id="running-unprivileged">Running Unprivileged</h4>
<p>To run the <code>go-xdp-counter</code> and <code>go-tc-counter</code> examples unprivileged (without <code>sudo</code>), the
following three steps must be performed.</p>
<h5 id="step-1-create-bpfd-user-group">Step 1: Create <code>bpfd</code> User Group</h5>
<p>The <a href="../tutorial/">Tutorial</a> guide describes the different modes <code>bpfd</code> can be run in.
Specifically, the <a href="../tutorial/#systemd-service">Systemd Service</a> section explains how to
start <code>bpfd</code> and create the <code>bpfd</code> Users and <code>bpfd</code> User Group.
<code>bpfd</code> must be started as a Systemd Service and <code>go-xdp-counter</code> must be run from a User that is a
member of the <code>bpfd</code> User Group.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="go">    sudo usermod -a -G bpfd $USER</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="go">    exit</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="go">    &lt;LOGIN&gt;</span>
</code></pre></div>
<h5 id="step-2-grant-cap_bpf-linux-capability">Step 2: Grant CAP_BPF Linux Capability</h5>
<p><code>go-xdp-counter</code> and <code>go-tc-counter</code> use a map to share data between the userspace side of the program
and the BPF portion.
Accessing this map requires access to the CAP_BPF capability.
Run the following command to grant <code>go-xdp-counter</code> access to the CAP_BPF capability:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="go">    cd src/bpfd/examples/go-xdp-counter/</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="go">    sudo /sbin/setcap cap_dac_override,cap_bpf=ep ./go-xdp-counter</span>
</code></pre></div>
<p>and</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="go">    cd src/bpfd/examples/go-tc-counter/</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="go">    sudo /sbin/setcap cap_dac_override,cap_bpf=ep ./go-tc-counter</span>
</code></pre></div>
<p><strong>Reminder:</strong> The capability must be re-granted each time the examples are rebuilt.</p>
<h5 id="step-3-start-go-xdp-counter-without-sudo">Step 3: Start <code>go-xdp-counter</code> without <code>sudo</code></h5>
<p>Start <code>go-xdp-counter</code> without <code>sudo</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="go">    ./go-xdp-counter -iface ens3</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="go">    2022/12/02 15:59:34 Reading /etc/bpfd/gocounter.toml ...</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="go">    2022/12/02 15:59:34 Read /etc/bpfd/gocounter.toml failed: err open /etc/bpfd/gocounter.toml: no such file or directory</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="go">    2022/12/02 15:59:34 Using Input: Interface=ens3 Priority=50 Source=bpf_bpfel.o</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="go">    2022/12/02 15:59:35 Program registered with b6b2107c-f1a3-48ac-a145-1073c0979ba4 id</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="go">    2022/12/02 15:59:38 0 packets received</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="go">    2022/12/02 15:59:38 0 bytes received</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="go">    2022/12/02 15:59:41 4 packets received</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="go">    2022/12/02 15:59:41 580 bytes received</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="go">    :</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="go">    2022/12/02 16:00:59 64 packets received</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="go">    2022/12/02 16:00:59 9280 bytes received</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="go">    ^C2022/12/02 16:01:00 Exiting...</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="go">    2022/12/02 16:01:00 Unloading Program: b6b2107c-f1a3-48ac-a145-1073c0979ba4</span>
</code></pre></div>
<h3 id="passing-bpf-bytecode-in-a-container-image">Passing BPF Bytecode In A Container Image</h3>
<p>bpfd can load BPF bytecode from a container image built following the spec described in
<a href="../shipping-bytecode/">EBPF Bytecode Image Specifications</a>.
Pre-built <code>go-xdp-counter</code> and <code>go-tc-counter</code> BPF container images can be loaded from
<code>quay.io/bpfd-bytecode/go-xdp-counter:latest</code> or <code>quay.io/bpfd-bytecode/go-tc-counter:latest</code>.
To use the container image, pass the URL to the userspace program:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="go">    ./go-xdp-counter -iface ens3 -location image://quay.io/bpfd-bytecode/go-xdp-counter:latest</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="go">    2022/12/02 16:28:32 Reading /etc/bpfd/gocounter.toml ...</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="go">    2022/12/02 16:28:32 Read /etc/bpfd/gocounter.toml failed: err open /etc/bpfd/gocounter.toml: no such file or directory</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="go">    2022/12/02 16:28:32 Using Input: Interface=ens3 Priority=50 Source=quay.io/bpfd-bytecode/go-xdp-counter:latest</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="go">    2022/12/02 16:28:34 Program registered with 8d89a6b6-bce2-4d3f-9cee-9cb0c689a90e id</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="go">    2022/12/02 16:28:37 4 packets received</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="go">    2022/12/02 16:28:37 580 bytes received</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="go">    2022/12/02 16:28:40 4 packets received</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="go">    2022/12/02 16:28:40 580 bytes received</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="go">    ^C2022/12/02 16:28:42 Exiting...</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="go">    2022/12/02 16:28:42 Unloading Program: 8d89a6b6-bce2-4d3f-9cee-9cb0c689a90e</span>
</code></pre></div>
<h4 id="building-bpf-bytecode-container-image">Building BPF Bytecode Container Image</h4>
<p><a href="../shipping-bytecode/">EBPF Bytecode Image Specifications</a> provides detailed instructions on
building and shipping bytecode in a container image.
To build <code>go-xdp-counter</code> and <code>go-tc-counter</code> BPF bytecode container image, first make sure the
bytecode has been built (i.e. <code>bpf_bpfel.o</code> has been built - see <a href="#building]">Building</a>, then
run the build commands below:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="go">    cd src/bpfd/examples/go-xdp-counter/</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="go">    go generate</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="go">    docker build \</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="go">      --build-arg PROGRAM_NAME=go-xdp-counter \</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="go">      --build-arg SECTION_NAME=stats \</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="go">      --build-arg PROGRAM_TYPE=xdp \</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="go">      --build-arg BYTECODE_FILENAME=bpf_bpfel.o \</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="go">      --build-arg KERNEL_COMPILE_VER=$(uname -r) \</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="go">      -f ../../packaging/container-deployment/Containerfile.bytecode . -t quay.io/$USER/go-xdp-counter-bytecode:latest</span>
</code></pre></div>
<p>and</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="go">    cd src/bpfd/examples/go-tc-counter/</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="go">    go generate</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="go">    docker build \</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="go">      --build-arg PROGRAM_NAME=go-tc-counter \</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="go">      --build-arg SECTION_NAME=stats \</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="go">      --build-arg PROGRAM_TYPE=tc \</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="go">      --build-arg BYTECODE_FILENAME=bpf_bpfel.o \</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="go">      --build-arg KERNEL_COMPILE_VER=$(uname -r) \</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="go">      -f ../../packaging/container-deployment/Containerfile.bytecode . -t quay.io/$USER/go-tc-counter-bytecode:latest</span>
</code></pre></div>
<p><code>bpfd</code> currently only supports pulling a remote container image, so push the image to a remote
repository.
For example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="go">    docker login quay.io</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="go">    docker push quay.io/$USER/go-xdp-counter-bytecode:latest</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="go">    docker push quay.io/$USER/go-tc-counter-bytecode:latest</span>
</code></pre></div>
<p>Then run with the privately built bytecode container image:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="go">    ./go-tc-counter -iface ens3 -direction ingress -location image://quay.io/$USER/go-tc-counter-bytecode:latest</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="go">    2022/12/02 16:38:44 Reading /etc/bpfd/gocounter.toml ...</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="go">    2022/12/02 16:38:44 Read /etc/bpfd/gocounter.toml failed: err open /etc/bpfd/gocounter.toml: no such file or directory</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="go">    2022/12/02 16:38:44 Using Input: Interface=ens3 Priority=50 Source=quay.io/$USER/go-tc-counter-bytecode:latest</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="go">    2022/12/02 16:38:45 Program registered with 0d313a4a-a17c-4c70-81ba-3ecc494b900e id</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="go">    2022/12/02 16:38:48 4 packets received</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="go">    2022/12/02 16:38:48 580 bytes received</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="go">    2022/12/02 16:38:51 4 packets received</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="go">    2022/12/02 16:38:51 580 bytes received</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="go">    ^C2022/12/02 16:38:51 Exiting...</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="go">    2022/12/02 16:38:51 Unloading Program: 0d313a4a-a17c-4c70-81ba-3ecc494b900e</span>
</code></pre></div>
<h4 id="preloading-bpf-bytecode">Preloading BPF Bytecode</h4>
<p>Another way to load the BPF bytecode is to pre-load the BPF bytecode and
pass the associated <code>bpfd</code> UUID to the userspace program.
This is similar to how BPF programs will be loaded in Kubernetes, except <code>kubectl</code> commands will be
used to create <code>bpfProgramConfig</code> kubernetes object objects instead of using <code>bpfctl</code>, but that
is covered in the next section.
The userspace programs will skip the loading portion and use the UUID to find the shared
map and continue from there.</p>
<p>Referring back to the diagram above, the <code>load</code> and <code>unload</code> are being done by <code>bpfctl</code> and not
<code>go-xdp-counter</code> userspace program.</p>
<p>First, use <code>bpfctl</code> to load the <code>go-xdp-counter</code> BPF bytecode:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="go">    bpfctl load --location image://quay.io/bpfd-bytecode/go-xdp-counter:latest xdp --iface ens3 --priority 50</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="go">    d541af30-69be-44cf-9397-407ee512547a</span>
</code></pre></div>
<p>Then run the <code>go-xdp-counter</code> userspace program, passing in the UUID:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="go">    ./go-xdp-counter -iface ens3 -uuid d541af30-69be-44cf-9397-407ee512547a</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="go">    2022/12/02 17:01:38 Using Input: Interface=ens3 Source=d541af30-69be-44cf-9397-407ee512547a</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="go">    2022/12/02 17:01:41 180 packets received</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="go">    2022/12/02 17:01:41 26100 bytes received</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="go">    2022/12/02 17:01:44 184 packets received</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="go">    2022/12/02 17:01:44 26680 bytes received</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="go">    ^C2022/12/02 17:01:46 Exiting...</span>
</code></pre></div>
<p>Then use <code>bpfctl</code> to unload the BPF bytecode:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="go">    bpfctl unload d541af30-69be-44cf-9397-407ee512547a</span>
</code></pre></div>
<h2 id="deploying-on-kubernetes">Deploying On Kubernetes</h2>
<p>This section will describe loading bytecode on a Kubernetes cluster and launching the userspace
program.
The approach is slightly different when running on a Kubernetes cluster.
The BPF bytecode should be loaded by an administrator, not the userspace program itself.</p>
<p><img alt="gocounter On Kubernetes" src="../img/gocounter-on-k8s.png" /></p>
<h3 id="loading-bpf-bytecode-on-kubernetes">Loading BPF Bytecode On Kubernetes</h3>
<p>This assumes there is already a Kubernetes cluster running and <code>bpfd</code> is running in the cluster
(see <a href="../k8s-deployment/">How to Manually Deploy bpfd on Kubernetes</a>).
Instead of using the userspace program or <code>bpfctl</code> to load the BPF bytecode as done above, the bytecode
will be loaded by creating a <code>BpfProgramConfig</code> kubernetes object.
Edit the
<a href="https://github.com/redhat-et/bpfd/tree/main/examples/go-xdp-counter/kubernetes-deployment/go-xdp-counter-bytecode.yaml">go-xdp-counter-bytecode.yaml</a>
file to customize, primarily setting the interface.
Also note that the <code>BpfProgramConfig</code> is running the bytecode on all nodes (<code>nodeselector: {}</code>).
This can be change to run on specific nodes, but the DaemonSet yaml for the userspace program, which
is described below, should have an equivalent change
(see <a href="https://github.com/redhat-et/bpfd/tree/main/examples/go-xdp-counter/kubernetes-deployment/go-xdp-counter.yaml">go-xdp-counter.yaml</a>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="go">    vi examples/go-xdp-counter/kubernetes-deployment/go-xdp-counter-bytecode.yaml</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="go">    apiVersion: bpfd.io/v1alpha1</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="go">    kind: BpfProgramConfig</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="go">    metadata:</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="go">      labels:</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="go">        app.kubernetes.io/name: bpfprogramconfig</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="go">      name: go-xdp-counter-example</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="go">    spec:</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="gp">      #</span><span class="c1"># Must correspond to image section name</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="go">      name: stats</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="go">      type: XDP</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="gp">      # </span>Select all nodes
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="go">      nodeselector: {}</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="go">      attachpoint:</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="go">        networkmultiattach:</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="go">          interface: eth0</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="go">          priority: 55</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="go">      bytecode: image://quay.io/bpfd-bytecode/go-xdp-counter-latest</span>
</code></pre></div>
<p>Repeat for <code>go-tc-counter-bytecode.yaml</code> and then apply the updated yamls:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="go">    kubectl apply -f examples/go-xdp-counter/kubernetes-deployment/go-xdp-counter-bytecode.yaml</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="go">    bpfprogramconfig.bpfd.io/go-xdp-counter-example created</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="go">    kubectl apply -f examples/go-tc-counter/kubernetes-deployment/go-tc-counter-bytecode.yaml</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="go">    bpfprogramconfig.bpfd.io/go-tc-counter-example created</span>
</code></pre></div>
<p>Following the diagram (Blue numbers):</p>
<ol>
<li>The user creates a <code>BpfProgramConfig</code> object with the parameters
associated with the BPF bytecode, like interface, priority and BFP bytecode image.
The name of the <code>BpfProgramConfig</code> object in this example is <code>go-xdp-counter-example</code>.</li>
<li><code>bpfd-agent</code>, running on each node, is watching for all changes to <code>BpfProgramConfig</code> objects.
When it sees a <code>BpfProgramConfig</code> object modified, it makes sure a <code>BpfProgram</code> object for that
node exists. The name of the <code>BpfProgram</code> object is the <code>BpfProgramConfig</code> object name with the
node name appended.</li>
<li><code>bpfd-agent</code> then determines if it should be running on the given node, loads or unloads as needed
by making gRPC calls the <code>bpfd</code>.
<code>bpfd</code> behaves the same as described in the running locally example.</li>
<li><code>bpfd-agent</code> finally updates the status of the <code>BpfProgram</code> object.</li>
<li><code>bpfd-operator</code> watches all <code>BpfProgram</code> objects, and updates the status of the <code>BpfProgramConfig</code>
object indicating if the BPF program has been applied to all the desired nodes or not.</li>
</ol>
<p>To retrieve information on the <code>BpfProgramConfig</code> objects:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="go">    kubectl get bpfprogramconfigs</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="go">    NAME                     AGE</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="go">    go-tc-counter-example    3d5h</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="go">    go-xdp-counter-example   3d5h</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="go">    kubectl get bpfprogramconfigs go-xdp-counter-example -o yaml</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="go">    apiVersion: bpfd.io/v1alpha1</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="go">    kind: BpfProgramConfig</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="go">    metadata:</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="go">      creationTimestamp: &quot;2023-01-06T15:04:22Z&quot;</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="go">      finalizers:</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="go">      - bpfd.io.operator/finalizer</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="go">      generation: 1</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="go">      labels:</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="go">        app.kubernetes.io/name: bpfprogramconfig</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="go">      name: go-xdp-counter-example</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="go">      resourceVersion: &quot;268771&quot;</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="go">      uid: 81a9d2ea-52fc-4c5a-8a57-d3189119fad2</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="go">    spec:</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="go">      attachpoint:</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="go">        networkmultiattach:</span>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="go">          direction: NONE</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="go">          interface: eth0</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="go">          priority: 55</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="go">      bytecode: image://quay.io/bpfd-bytecode/go-xdp-counter:latest</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="go">      name: stats</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="go">      nodeselector: {}</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="go">      type: XDP</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="go">    status:</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="go">      conditions:</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="go">      - lastTransitionTime: &quot;2023-01-06T15:04:22Z&quot;</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="go">        message: Waiting for BpfProgramConfig Object to be reconciled to all nodes</span>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="go">        reason: ProgramsNotYetLoaded</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="go">        status: &quot;True&quot;</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="go">        type: NotYetLoaded</span>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="go">      - lastTransitionTime: &quot;2023-01-06T15:04:22Z&quot;</span>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="go">        message: bpfProgramReconciliation Succeeded on all nodes</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="go">        reason: ReconcileSuccess</span>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="go">        status: &quot;True&quot;</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="go">        type: ReconcileSuccess</span>
</code></pre></div>
<p>To retrieve information on the <code>BpfProgram</code> objects:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="go">    kubectl get bpfprograms</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="go">    NAME                                                   AGE</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="go">    go-tc-counter-example-bpfd-deployment-control-plane    3d5h</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="go">    go-tc-counter-example-bpfd-deployment-worker           3d5h</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="go">    go-tc-counter-example-bpfd-deployment-worker2          3d5h</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="go">    go-xdp-counter-example-bpfd-deployment-control-plane   3d5h</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="go">    go-xdp-counter-example-bpfd-deployment-worker          3d5h</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="go">    go-xdp-counter-example-bpfd-deployment-worker2         3d5h</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="go">    kubectl get bpfprograms go-xdp-counter-example-bpfd-deployment-worker -o yaml</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="go">    apiVersion: bpfd.io/v1alpha1</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="go">    kind: BpfProgram</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="go">    metadata:</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="go">      creationTimestamp: &quot;2023-01-06T15:04:22Z&quot;</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="go">      finalizers:</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="go">      - bpfd.io.agent/finalizer</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="go">      generation: 2</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="go">      labels:</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="go">        owningConfig: go-xdp-counter-example</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="go">      name: go-xdp-counter-example-bpfd-deployment-worker</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="go">      ownerReferences:</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="go">      - apiVersion: bpfd.io/v1alpha1</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="go">        blockOwnerDeletion: true</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="go">        controller: true</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="go">        kind: BpfProgramConfig</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="go">        name: go-xdp-counter-example</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="go">        uid: 81a9d2ea-52fc-4c5a-8a57-d3189119fad2</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="go">      resourceVersion: &quot;268828&quot;</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="go">      uid: 7957b711-d752-4893-8a8d-7d48c3afaa53</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="go">    spec:</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="go">      programs:</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="go">        30f8264a-ba07-4adc-9824-85a2c755e85e:</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a><span class="go">          attachpoint:</span>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="go">            networkmultiattach:</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="go">              direction: NONE</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="go">              interface: eth0</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="go">              priority: 55</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="go">              proceedon: []</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a><span class="go">          maps:</span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="go">            xdp_stats_map: /run/bpfd/fs/maps/30f8264a-ba07-4adc-9824-85a2c755e85e/xdp_stats_map</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="go">    status:</span>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="go">      conditions:</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="go">      - lastTransitionTime: &quot;2023-01-06T15:04:23Z&quot;</span>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a><span class="go">        message: Successfully loaded bpfProgram</span>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="go">        reason: bpfdLoaded</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a><span class="go">        status: &quot;True&quot;</span>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="go">        type: Loaded</span>
</code></pre></div>
<h3 id="loading-userspace-container-on-kubernetes">Loading Userspace Container On Kubernetes</h3>
<h4 id="building-a-userspace-container-image">Building A Userspace Container Image</h4>
<p>To build the <code>go-xdp-counter</code> and <code>go-tc-counter</code> userspace examples in a container, from the bpfd code
source directory, run the following build commands:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="go">    cd src/bpfd/</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="go">    docker build -f examples/go-xdp-counter/container-deployment/Containerfile.go-xdp-counter . -t quay.io/$USER/go-xdp-counter:latest</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="go">    docker build -f examples/go-tc-counter/container-deployment/Containerfile.go-tc-counter . -t quay.io/$USER/go-tc-counter:latest</span>
</code></pre></div>
<p>Then push images to a remote repository:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="go">    docker login quay.io</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="go">    docker push quay.io/$USER/go-xdp-counter:latest</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="go">    docker push quay.io/$USER/go-tc-counter:latest</span>
</code></pre></div>
<h4 id="loading-a-userspace-container-image">Loading A Userspace Container Image</h4>
<p>The userspace program in a Kubernetes Deployment no longer interacts directly with <code>bpfd</code>.
Instead, the userspace program running on each node reads the <code>BpdProgram</code> to determine the
map location.
For example, the output above shows the maps as:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="go">    kubectl get bpfprograms go-xdp-counter-example-bpfd-deployment-worker -o yaml</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="go">    :</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="go">    spec:</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="go">      programs:</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="go">        30f8264a-ba07-4adc-9824-85a2c755e85e:</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="go">    :</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="go">          maps:</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="go">            xdp_stats_map: /run/bpfd/fs/maps/30f8264a-ba07-4adc-9824-85a2c755e85e/xdp_stats_map</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="go">    :</span>
</code></pre></div>
<p>To interact with the KubeApiServer, RBAC must be setup properly to access the <code>BpdProgram</code>
object.
The <code>bpfd-operator</code> defined the yaml for several ClusterRoles that can be used to access the
different <code>bpfd</code> related CRD objects with different access rights.
The example userspace containers will use the <code>bpfprogram-viewer-role</code>, which allows Read-Only
access to the <code>BpfProgram</code> object.
This ClusterRole is created automatically by the  <code>bpfd-operator</code>.</p>
<p>The remaining objects (NameSpace, ServiceAccount, ClusterRoleBinding and examples DaemonSet)
also need to be created.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="go">    cd src/bpfd/</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="go">    kubectl create -f examples/go-xdp-counter/kubernetes-deployment/go-xdp-counter.yaml</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="go">    kubectl create -f examples/go-tc-counter/kubernetes-deployment/go-tc-counter.yaml</span>
</code></pre></div>
<p>Following the diagram (Green numbers):</p>
<ol>
<li>The userspace program queries the KubeApiServer for a specific <code>BpfProgram</code> object.</li>
<li>The userspace program pulls the file location of the shared map out of the <code>BpfProgram</code>
object and uses the file to periodically read the counter values.</li>
</ol>
<p>To see if the userspace programs are working, view the logs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="go">    kubectl get pods -A</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="go">    NAMESPACE       NAME                       READY   STATUS    RESTARTS   AGE</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="go">    :</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="go">    go-tc-counter   go-tc-counter-ds-k7vmp     1/1     Running   0          3d7h</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="go">    go-tc-counter   go-tc-counter-ds-r77mq     1/1     Running   0          3d7h</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="go">    go-tc-counter   go-tc-counter-ds-wds65     1/1     Running   0          3d7h</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="go">    go-xdp-counter  go-xdp-counter-ds-5q4hz    1/1     Running   0          3d7h</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="go">    go-xdp-counter  go-xdp-counter-ds-bbm9c    1/1     Running   0          3d7h</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="go">    go-xdp-counter  go-xdp-counter-ds-dn247    1/1     Running   0          3d7h</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="go">    :</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="go">    kubectl logs -n go-xdp-counter go-xdp-counter-ds-5q4hz</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="go">    2023/01/08 08:47:55 908748 packets received</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="go">    2023/01/08 08:47:55 631463477 bytes received</span>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="go">    2023/01/08 08:47:58 908757 packets received</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="go">    2023/01/08 08:47:58 631466099 bytes received</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="go">    2023/01/08 08:48:01 908778 packets received</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="go">    2023/01/08 08:48:01 631472201 bytes received</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="go">    2023/01/08 08:48:04 908791 packets received</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="go">    2023/01/08 08:48:04 631480013 bytes received</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="go">    :</span>
</code></pre></div>
<p>To cleanup:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="go">    kubectl delete -f examples/go-xdp-counter/kubernetes-deployment/go-xdp-counter.yaml</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="go">    kubectl delete -f examples/go-xdp-counter/kubernetes-deployment/go-xdp-counter-bytecode.yaml</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="go">    kubectl delete -f examples/go-tc-counter/kubernetes-deployment/go-tc-counter.yaml</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="go">    kubectl delete -f examples/go-tc-counter/kubernetes-deployment/go-tc-counter-bytecode.yaml</span>
</code></pre></div>
<h2 id="notes">Notes</h2>
<p>Notes regarding this document:</p>
<ul>
<li>Source of images used in this document can be found in
  <a href="https://docs.google.com/presentation/d/1wU4xu6xeyk9cB3G-Nn-dzkf90j1-EI4PB167G7v-Xl4/edit?usp=sharing">bpfd Upstream Images</a>.
  Request access if required.</li>
</ul>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../building-bpfd/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Setup and Building bpfd" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Setup and Building bpfd
            </div>
          </div>
        </a>
      
      
        
        <a href="../k8s-deployment/" class="md-footer__link md-footer__link--next" aria-label="Next: How to Deploy bpfd on Kubernetes" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              How to Deploy bpfd on Kubernetes
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-2023 The bpfd contribtutors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.tabs", "navigation.tabs.sticky", "content.code.annotate"], "search": "../assets/javascripts/workers/search.85cb4492.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.a877e258.min.js"></script>
      
    
  </body>
</html>